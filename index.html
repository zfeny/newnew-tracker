<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手艺生活记录</title>
    <style>
        :root {
            --primary-color: #1890ff;
            --secondary-color: #e6f7ff;
            --text-color: #333;
            --background-color: #f5f7fa;
            --card-color: rgba(255, 255, 255, 0.8);
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 500px;
            margin: 24px auto;
            padding: 0;
        }
        
        .glass-card {
            background-color: var(--card-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            transition: box-shadow 0.3s ease;
        }
        
        .glass-card:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-color);
            font-weight: 500;
            position: relative;
        }
        
        .tab.active {
            color: var(--primary-color);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-color);
            border-radius: 2px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        
        h1 {
            font-size: 20px;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .github-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #24292e;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            padding: 8px 16px;
            margin: 15px auto;
            width: fit-content;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .github-button:hover {
            background-color: #1a1f24;
        }
        
        .star-icon {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .record-container {
            text-align: center;
            padding: 20px 0;
        }
        
        .record-title {
            color: var(--primary-color);
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .status-text {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #555;
        }
        
        .timer-display {
            font-size: 32px;
            font-family: monospace;
            margin: 20px 0;
            color: #2c3e50;
        }
        
        .action-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 40px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(24, 144, 255, 0.3);
        }
        
        .action-button:active {
            transform: translateY(1px);
        }
        
        .action-button.stopping {
            background-color: #e74c3c;
        }
        
        .play-icon {
            margin-right: 8px;
        }
        
        .notes-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 15px;
            resize: none;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        .export-import-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .export-import-button {
            display: flex;
            align-items: center;
            background-color: white;
            border: 1px solid #ddd;
            color: #555;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .export-import-button:hover {
            background-color: #f9f9f9;
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }
        
        .stats-container {
            margin-top: 20px;
        }
        
        .stats-title {
            color: var(--primary-color);
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            text-align: center;
            transition: all 0.3s ease;
            cursor: default;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(24, 144, 255, 0.25);
        }
        
        .stat-title {
            color: #7f8c8d;
            font-size: 14px;
            margin: 0 0 5px 0;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0;
        }
        
        .calendar-container {
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: visible;
        }
        
        .calendar-title {
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
            color: var(--primary-color);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 2px;
        }
        
        .calendar-day {
            width: 40px;
            height: 40px;
            background-color: #eee;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: #555;
            position: relative;
            margin: 0 auto;
        }
        
        .calendar-day:hover {
            transform: scale(1.08);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        .calendar-day.level-1 { background-color: #c6e48b; }
        .calendar-day.level-2 { background-color: #7bc96f; }
        .calendar-day.level-3 { background-color: #239a3b; }
        .calendar-day.level-4 { background-color: #196127; }
        
        .calendar-day.current {
            border: 2px solid var(--primary-color);
        }
        
        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .navigation-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-button:hover {
            background-color: #40a9ff;
            transform: translateY(-2px);
        }
        
        .current-month {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            min-width: 120px;
            text-align: center;
        }
        
        .history-filter {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        
        .filter-title {
            font-weight: 500;
            color: #555;
        }
        
        .filter-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        
        .filter-date-container {
            display: flex;
            gap: 8px;
        }
        
        .filter-date-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        
        .filter-button {
            padding: 6px 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-button:hover {
            background-color: #40a9ff;
        }
        
        .view-toggle {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .view-option {
            padding: 4px 10px;
            background-color: #f5f5f5;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            user-select: none;
        }
        
        .view-option.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* 年视图样式 */
        .year-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 15px;
        }
        
        .month-cell {
            background-color: #f9f9f9;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .month-name {
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .mini-month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .mini-day {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            background-color: #eee;
        }
        
        .mini-day.level-1 { background-color: #c6e48b; }
        .mini-day.level-2 { background-color: #7bc96f; }
        .mini-day.level-3 { background-color: #239a3b; }
        .mini-day.level-4 { background-color: #196127; }
        
        .weekday-labels {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            color: #7f8c8d;
            text-align: center;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(33, 37, 41, 0.95);
            backdrop-filter: blur(5px);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25), 0 2px 4px rgba(0, 0, 0, 0.3);
            width: 280px;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: translateY(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            top: -145px;
            left: 50%;
            margin-left: -140px;
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            margin-left: -10px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: rgba(33, 37, 41, 0.95) transparent transparent transparent;
        }
        
        .tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .tooltip-title {
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--primary-color);
        }
        
        .tooltip-record {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
            line-height: 1.5;
        }
        
        .tooltip-record:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .tooltip-time {
            font-weight: bold;
            color: #7ddcff;
            margin-right: 6px;
        }
        
        .tooltip-duration {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 4px;
        }
        
        .tooltip-note {
            display: block;
            margin-top: 4px;
            font-style: italic;
            color: rgba(255, 255, 255, 0.7);
            padding-left: 4px;
            font-size: 11px;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th, .history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .history-table th {
            font-weight: 500;
            color: #7f8c8d;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 0;
            color: #7f8c8d;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .hidden {
            display: none;
        }
        
        .delete-btn {
            padding: 4px 8px;
            background-color: #ff4d4f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .delete-btn:hover {
            background-color: #ff7875;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 主卡片 -->
        <div class="glass-card">
            <div class="tabs">
                <div class="tab active" data-tab="log">主页面</div>
                <div class="tab" data-tab="history">历史记录</div>
            </div>
            
            <div class="tab-content active" id="log">
                <p style="text-align: center;">祝愿所有给本项目Star的小伙伴子子孙孙!!</p>
                
                <a href="https://github.com/zfeny/newnew-tracker" class="github-button" target="_blank">
                    <span class="star-icon">⭐</span> Star on GitHub
                </a>
                
                <div class="record-container">
                    <h3 class="record-title">记录新的手艺活</h3>
                    
                    <div id="statusContainer">
                        <p class="status-text" id="statusText">准备开始</p>
                    </div>
                    
                    <div id="timerContainer" class="hidden">
                        <p class="timer-display" id="timerDisplay">00:00:00</p>
                    </div>
                    
                    <button id="actionButton" class="action-button">
                        <span class="play-icon">▶</span> 开始
                    </button>
                    
                    <textarea id="notesInput" class="notes-input hidden" placeholder="备注（可选）" rows="3"></textarea>
                </div>
                
                <div class="export-import-buttons">
                    <button id="exportBtn" class="export-import-button">
                        <span style="margin-right: 5px;">⬇️</span> 导出数据
                    </button>
                    <button id="importBtn" class="export-import-button">
                        <span style="margin-right: 5px;">⬆️</span> 导入数据
                    </button>
                    <input type="file" id="importFile" style="display: none;">
                </div>
            </div>
            
            <div class="tab-content" id="history">
                <div id="recordsTableContainer">
                    <div class="history-filter">
                        <div class="filter-title">筛选记录：</div>
                        <select id="historyFilterType" class="filter-select">
                            <option value="all">全部记录</option>
                            <option value="month">按月筛选</option>
                            <option value="year">按年筛选</option>
                        </select>
                        <div id="monthFilterContainer" class="filter-date-container hidden">
                            <select id="yearSelect" class="filter-date-select"></select>
                            <select id="monthSelect" class="filter-date-select"></select>
                        </div>
                        <div id="yearFilterContainer" class="filter-date-container hidden">
                            <select id="yearOnlySelect" class="filter-date-select"></select>
                        </div>
                        <button id="applyFilterBtn" class="filter-button">应用筛选</button>
                    </div>
                    <table class="history-table" id="recordsTable">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>时长</th>
                                <th>备注</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody">
                            <!-- 记录将在这里动态添加 -->
                        </tbody>
                    </table>
                    <div id="emptyRecords" class="empty-state">
                        没有记录，开始添加记录吧！
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 统计卡片 -->
        <div class="glass-card" id="statsCard">
            <div class="stats-container">
                <h3 class="stats-title">统计数据</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 class="stat-title">总次数</h3>
                        <p class="stat-value" id="totalCount">0</p>
                    </div>
                    <div class="stat-card">
                        <h3 class="stat-title">平均持续时间</h3>
                        <p class="stat-value" id="avgDuration">0</p>
                    </div>
                    <div class="stat-card">
                        <h3 class="stat-title">本周次数</h3>
                        <p class="stat-value" id="weeklyCount">0</p>
                    </div>
                    <div class="stat-card">
                        <h3 class="stat-title">本月次数</h3>
                        <p class="stat-value" id="monthlyCount">0</p>
                    </div>
                </div>
                
                <div class="calendar-container">
                    <div class="month-header">
                        <div class="navigation-controls">
                            <button id="prevButton" class="nav-button">&lt;</button>
                            <div class="current-month" id="currentMonth">2025年3月</div>
                            <button id="nextButton" class="nav-button">&gt;</button>
                        </div>
                        <div class="view-toggle">
                            <div class="view-option active" data-view="month">月</div>
                            <div class="view-option" data-view="year">年</div>
                        </div>
                    </div>
                    
                    <!-- 月视图 -->
                    <div id="monthView">
                        <div class="weekday-labels">
                            <div>一</div>
                            <div>二</div>
                            <div>三</div>
                            <div>四</div>
                            <div>五</div>
                            <div>六</div>
                            <div>日</div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- 日历格子将动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 年视图 -->
                    <div id="yearView" class="hidden">
                        <div class="year-grid" id="yearGrid">
                            <!-- 年历表格将动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>本应用在本地运行，您的数据不会被传输到网络上</p>
        </footer>
    </div>

    <script>
        // 初始化localStorage
        if (!localStorage.getItem('records')) {
            localStorage.setItem('records', JSON.stringify([]));
        }
        
        // DOM元素
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const actionButton = document.getElementById('actionButton');
        const statusText = document.getElementById('statusText');
        const timerContainer = document.getElementById('timerContainer');
        const timerDisplay = document.getElementById('timerDisplay');
        const notesInput = document.getElementById('notesInput');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const totalCountEl = document.getElementById('totalCount');
        const avgDurationEl = document.getElementById('avgDuration');
        const weeklyCountEl = document.getElementById('weeklyCount');
        const monthlyCountEl = document.getElementById('monthlyCount');
        const recordsTable = document.getElementById('recordsTable');
        const recordsTableBody = document.getElementById('recordsTableBody');
        const emptyRecords = document.getElementById('emptyRecords');
        const calendarGrid = document.getElementById('calendarGrid');
        const viewToggleOptions = document.querySelectorAll('.view-option');
        const monthView = document.getElementById('monthView');
        const yearView = document.getElementById('yearView');
        const yearGrid = document.getElementById('yearGrid');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const currentMonthEl = document.getElementById('currentMonth');
        const historyFilterType = document.getElementById('historyFilterType');
        const monthFilterContainer = document.getElementById('monthFilterContainer');
        const yearFilterContainer = document.getElementById('yearFilterContainer');
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const yearOnlySelect = document.getElementById('yearOnlySelect');
        const applyFilterBtn = document.getElementById('applyFilterBtn');
        
        // 状态变量
        let currentCalendarView = 'month';
        let currentDisplayDate = new Date();
        let historyFilterCriteria = { type: 'all' };
        
        // 计时器变量
        let timerInterval;
        let timerRunning = false;
        let startTime;
        let elapsedTime = 0;
        
        // 标签切换
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // 显示/隐藏统计卡片
                const statsCard = document.getElementById('statsCard');
                if (tabId === 'history') {
                    renderRecords();
                    statsCard.style.display = 'none';
                } else {
                    statsCard.style.display = 'block';
                }
            });
        });
        
        // 视图切换
        viewToggleOptions.forEach(option => {
            option.addEventListener('click', () => {
                viewToggleOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                
                const viewType = option.getAttribute('data-view');
                currentCalendarView = viewType;
                
                if (viewType === 'month') {
                    monthView.classList.remove('hidden');
                    yearView.classList.add('hidden');
                    generateMonthCalendar();
                } else {
                    monthView.classList.add('hidden');
                    yearView.classList.remove('hidden');
                    generateYearCalendar();
                }
            });
        });
        
        // 初始化历史记录筛选器
        function initHistoryFilters() {
            populateDateFilters();
            historyFilterType.value = 'all';
            monthFilterContainer.classList.add('hidden');
            yearFilterContainer.classList.add('hidden');
        }
        
        // 开始/停止按钮
        actionButton.addEventListener('click', () => {
            if (!timerRunning) {
                startTimer();
            } else {
                stopTimer();
            }
        });
        
        // 开始计时
        function startTimer() {
            timerRunning = true;
            startTime = Date.now();
            elapsedTime = 0;
            
            timerInterval = setInterval(updateTimer, 1000);
            
            // 更新UI
            actionButton.innerHTML = '<span class="play-icon">■</span> 结束';
            actionButton.classList.add('stopping');
            statusText.textContent = '正在记录...';
            timerContainer.classList.remove('hidden');
            notesInput.classList.add('hidden');
        }
        
        // 停止计时
        function stopTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
            
            // 更新UI
            actionButton.innerHTML = '<span class="play-icon">✓</span> 保存';
            actionButton.classList.remove('stopping');
            statusText.textContent = '完成了吗？';
            notesInput.classList.remove('hidden');
            
            // 设置一次性点击事件来保存记录
            actionButton.removeEventListener('click', saveRecord);
            actionButton.addEventListener('click', saveRecord, { once: true });
        }
        
        // 更新计时器显示
        function updateTimer() {
            elapsedTime = Date.now() - startTime;
            
            const seconds = Math.floor((elapsedTime / 1000) % 60);
            const minutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
            const hours = Math.floor(elapsedTime / (1000 * 60 * 60));
            
            timerDisplay.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // 保存记录
        function saveRecord() {
            // 计算持续时间（分钟）
            const durationMinutes = elapsedTime / 60000;
            
            // 创建记录对象
            const record = {
                id: Date.now(),
                date: new Date().toISOString(),
                duration: parseFloat(durationMinutes.toFixed(1)),
                notes: notesInput.value
            };
            
            // 获取现有记录并添加新记录
            const records = JSON.parse(localStorage.getItem('records'));
            records.push(record);
            localStorage.setItem('records', JSON.stringify(records));
            
            // 重置UI
            resetUI();
            
            // 更新统计
            updateStats();
            
            // 如果在历史标签页，刷新记录
            if (document.querySelector('.tab[data-tab="history"]').classList.contains('active')) {
                renderRecords();
            }
        }
        
        // 重置UI
        function resetUI() {
            actionButton.innerHTML = '<span class="play-icon">▶</span> 开始';
            actionButton.classList.remove('stopping');
            statusText.textContent = '准备开始';
            timerContainer.classList.add('hidden');
            notesInput.classList.add('hidden');
            notesInput.value = '';
            
            // 移除保存事件监听器
            actionButton.removeEventListener('click', saveRecord);
            
            // 恢复开始/停止事件监听器
            const newActionButton = actionButton.cloneNode(true);
            actionButton.parentNode.replaceChild(newActionButton, actionButton);
            document.getElementById('actionButton').addEventListener('click', () => {
                if (!timerRunning) {
                    startTimer();
                } else {
                    stopTimer();
                }
            });
        }
        
        // 渲染记录
        function renderRecords() {
            const allRecords = JSON.parse(localStorage.getItem('records'));
            
            if (allRecords.length === 0) {
                recordsTable.style.display = 'none';
                emptyRecords.style.display = 'block';
                emptyRecords.textContent = '没有记录，开始添加记录吧！';
                return;
            }
            
            // 筛选记录
            let filteredRecords = allRecords;
            
            if (historyFilterCriteria.type === 'month') {
                const year = historyFilterCriteria.year;
                const month = historyFilterCriteria.month;
                
                filteredRecords = allRecords.filter(record => {
                    const date = new Date(record.date);
                    return date.getFullYear() === year && date.getMonth() === month;
                });
                
            } else if (historyFilterCriteria.type === 'year') {
                const year = historyFilterCriteria.year;
                
                filteredRecords = allRecords.filter(record => {
                    const date = new Date(record.date);
                    return date.getFullYear() === year;
                });
            }
            
            if (filteredRecords.length === 0) {
                recordsTable.style.display = 'none';
                emptyRecords.style.display = 'block';
                emptyRecords.textContent = '没有符合筛选条件的记录';
                return;
            }
            
            recordsTable.style.display = 'table';
            emptyRecords.style.display = 'none';
            
            // 清空表格
            recordsTableBody.innerHTML = '';
            
            // 按日期降序排序
            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // 添加记录到表格
            filteredRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // 格式化日期
                const date = new Date(record.date);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${record.duration} 分钟</td>
                    <td>${record.notes || '-'}</td>
                    <td><button class="delete-btn" data-id="${record.id}">删除</button></td>
                `;
                
                recordsTableBody.appendChild(row);
            });
            
            // 添加删除按钮事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    if (confirm('确定要删除这条记录吗？')) {
                        deleteRecord(id);
                    }
                });
            });
        }
        
        // 删除记录
        function deleteRecord(id) {
            let records = JSON.parse(localStorage.getItem('records'));
            records = records.filter(record => record.id !== id);
            localStorage.setItem('records', JSON.stringify(records));
            
            renderRecords();
            updateStats();
            
            if (currentCalendarView === 'month') {
                generateMonthCalendar();
            } else {
                generateYearCalendar();
            }
        }
        
        // 更新统计
        function updateStats() {
            const records = JSON.parse(localStorage.getItem('records'));
            
            // 总次数
            totalCountEl.textContent = records.length;
            
            // 平均持续时间
            if (records.length > 0) {
                const totalDuration = records.reduce((sum, record) => sum + record.duration, 0);
                const avg = totalDuration / records.length;
                avgDurationEl.textContent = avg.toFixed(1);
            } else {
                avgDurationEl.textContent = '0';
            }
            
            // 计算本周和本月的记录
            const now = new Date();
            
            // 本周的开始（周一）
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
            weekStart.setHours(0, 0, 0, 0);
            
            // 本月的开始
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const weeklyRecords = records.filter(record => new Date(record.date) >= weekStart);
            const monthlyRecords = records.filter(record => new Date(record.date) >= monthStart);
            
            weeklyCountEl.textContent = weeklyRecords.length;
            monthlyCountEl.textContent = monthlyRecords.length;
            
            // 生成日历
            if (currentCalendarView === 'month') {
                generateMonthCalendar();
            } else {
                generateYearCalendar();
            }
        }
        
        // 月视图的月份切换
        prevButton.addEventListener('click', () => {
            if (currentCalendarView === 'month') {
                currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
                generateMonthCalendar();
            } else {
                currentDisplayDate.setFullYear(currentDisplayDate.getFullYear() - 1);
                generateYearCalendar();
            }
        });

        nextButton.addEventListener('click', () => {
            if (currentCalendarView === 'month') {
                currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
                generateMonthCalendar();
            } else {
                currentDisplayDate.setFullYear(currentDisplayDate.getFullYear() + 1);
                generateYearCalendar();
            }
        });
        
        // 历史记录筛选器设置
        historyFilterType.addEventListener('change', () => {
            const filterType = historyFilterType.value;
            monthFilterContainer.classList.add('hidden');
            yearFilterContainer.classList.add('hidden');
            
            if (filterType === 'month') {
                monthFilterContainer.classList.remove('hidden');
                populateDateFilters();
            } else if (filterType === 'year') {
                yearFilterContainer.classList.remove('hidden');
                populateDateFilters();
            }
        });
        
        applyFilterBtn.addEventListener('click', () => {
            const filterType = historyFilterType.value;
            
            if (filterType === 'all') {
                historyFilterCriteria = { type: 'all' };
            } else if (filterType === 'month') {
                historyFilterCriteria = { 
                    type: 'month',
                    year: parseInt(yearSelect.value),
                    month: parseInt(monthSelect.value)
                };
            } else if (filterType === 'year') {
                historyFilterCriteria = {
                    type: 'year',
                    year: parseInt(yearOnlySelect.value)
                };
            }
            
            renderRecords();
        });
        
        // 填充筛选器的年份和月份选项
        function populateDateFilters() {
            const records = JSON.parse(localStorage.getItem('records'));
            const years = new Set();
            const now = new Date();
            
            // 确保当前年份总是存在
            years.add(now.getFullYear());
            
            // 从记录中收集所有年份
            records.forEach(record => {
                const date = new Date(record.date);
                years.add(date.getFullYear());
            });
            
            // 按降序排序年份
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            // 填充年份选择器
            yearSelect.innerHTML = '';
            yearOnlySelect.innerHTML = '';
            
            sortedYears.forEach(year => {
                const yearOption = document.createElement('option');
                yearOption.value = year;
                yearOption.textContent = `${year}年`;
                yearSelect.appendChild(yearOption.cloneNode(true));
                yearOnlySelect.appendChild(yearOption);
            });
            
            // 填充月份选择器
            monthSelect.innerHTML = '';
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];
            
            monthNames.forEach((name, index) => {
                const monthOption = document.createElement('option');
                monthOption.value = index;
                monthOption.textContent = name;
                monthSelect.appendChild(monthOption);
            });
            
            // 默认选择当前月份和年份
            yearSelect.value = now.getFullYear();
            monthSelect.value = now.getMonth();
            yearOnlySelect.value = now.getFullYear();
        }
        
        // 生成月视图日历
        function generateMonthCalendar() {
            const records = JSON.parse(localStorage.getItem('records'));
            
            // 清空日历容器
            calendarGrid.innerHTML = '';
            
            // 设置当前月份标题
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];
            currentMonthEl.textContent = `${currentDisplayDate.getFullYear()}年${monthNames[currentDisplayDate.getMonth()]}`;
            
            // 获取当前月份的第一天和最后一天
            const firstDay = new Date(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth(), 1);
            const lastDay = new Date(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth() + 1, 0);
            
            // 计算每个日期的活动记录
            const activityRecords = {};
            records.forEach(record => {
                const date = new Date(record.date);
                // 只统计当前显示月份的记录
                if (date.getMonth() === currentDisplayDate.getMonth() && date.getFullYear() === currentDisplayDate.getFullYear()) {
                    const dateString = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                    
                    if (!activityRecords[dateString]) {
                        activityRecords[dateString] = [];
                    }
                    activityRecords[dateString].push(record);
                }
            });
            
            // 填充日历前面的空白（调整到周一开始）
            const firstDayOfWeek = firstDay.getDay(); // 0是周日，1是周一
            const padding = (firstDayOfWeek === 0) ? 6 : firstDayOfWeek - 1; // 调整为周一开始
            
            for (let i = 0; i < padding; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day';
                emptyCell.style.visibility = 'hidden';
                calendarGrid.appendChild(emptyCell);
            }
            
            // 填充当月的日期格子
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                cell.textContent = day;
                
                // 判断是否为当前日期
                const today = new Date();
                if (day === today.getDate() && 
                    currentDisplayDate.getMonth() === today.getMonth() && 
                    currentDisplayDate.getFullYear() === today.getFullYear()) {
                    cell.classList.add('current');
                }
                
                // 检查这一天是否有活动
                const dateString = `${currentDisplayDate.getFullYear()}-${currentDisplayDate.getMonth()}-${day}`;
                const dayRecords = activityRecords[dateString] || [];
                const count = dayRecords.length;
                
                // 添加级别类
                if (count > 0) {
                    const level = count === 1 ? 1 : count === 2 ? 2 : count === 3 ? 3 : 4;
                    cell.classList.add(`level-${level}`);
                    
                    // 为格子添加数据属性，用于显示详细信息
                    cell.setAttribute('data-records', JSON.stringify(dayRecords));
                    
                    // 添加鼠标事件 - 同时支持点击和悬浮
                    cell.addEventListener('click', showTooltip);
                    cell.addEventListener('mouseenter', showTooltip);
                    cell.addEventListener('mouseleave', hideTooltip);
                }
                
                calendarGrid.appendChild(cell);
            }
        }
        
        // 生成年视图日历
        function generateYearCalendar() {
            const records = JSON.parse(localStorage.getItem('records'));
            const currentYear = currentDisplayDate.getFullYear();
            
            // 清空年视图容器
            yearGrid.innerHTML = '';
            
            // 设置年份标题
            currentMonthEl.textContent = `${currentYear}年`;
            
            // 为每个月创建小月历
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];
            
            // 计算每个日期的活动记录
            const yearActivityRecords = {};
            records.forEach(record => {
                const date = new Date(record.date);
                // 只统计当年的记录
                if (date.getFullYear() === currentYear) {
                    const dateString = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                    
                    if (!yearActivityRecords[dateString]) {
                        yearActivityRecords[dateString] = [];
                    }
                    yearActivityRecords[dateString].push(record);
                }
            });
            
            // 获取当前日期用于高亮显示
            const today = new Date();
            
            // 创建每个月的小月历
            for (let month = 0; month < 12; month++) {
                const monthCell = document.createElement('div');
                monthCell.className = 'month-cell';
                
                // 月份名称
                const monthNameDiv = document.createElement('div');
                monthNameDiv.className = 'month-name';
                monthNameDiv.textContent = monthNames[month];
                monthCell.appendChild(monthNameDiv);
                
                // 创建小月历网格
                const miniMonthGrid = document.createElement('div');
                miniMonthGrid.className = 'mini-month-grid';
                
                // 获取当前月的第一天和最后一天
                const firstDay = new Date(currentYear, month, 1);
                const lastDay = new Date(currentYear, month + 1, 0);
                
                // 填充月历前面的空白（调整到周一开始）
                const firstDayOfWeek = firstDay.getDay(); // 0是周日，1是周一
                const padding = (firstDayOfWeek === 0) ? 6 : firstDayOfWeek - 1; // 调整为周一开始
                
                for (let i = 0; i < padding; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'mini-day';
                    emptyCell.style.visibility = 'hidden';
                    miniMonthGrid.appendChild(emptyCell);
                }
                
                // 填充月份的日期格子
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const cell = document.createElement('div');
                    cell.className = 'mini-day';
                    
                    // 检查这一天是否有活动
                    const dateString = `${currentYear}-${month}-${day}`;
                    const dayRecords = yearActivityRecords[dateString] || [];
                    const count = dayRecords.length;
                    
                    // 添加级别类
                    if (count > 0) {
                        const level = count === 1 ? 1 : count === 2 ? 2 : count === 3 ? 3 : 4;
                        cell.classList.add(`level-${level}`);
                        
                        // 为格子添加数据属性，用于显示详细信息
                        cell.setAttribute('data-date', `${currentYear}-${month + 1}-${day}`);
                        cell.setAttribute('data-records', JSON.stringify(dayRecords));
                        
                        // 添加点击事件以显示详细信息
                        cell.addEventListener('click', (e) => {
                            const records = JSON.parse(e.currentTarget.getAttribute('data-records'));
                            const dateStr = e.currentTarget.getAttribute('data-date');
                            showYearViewDetails(dateStr, records);
                        });
                    }
                    
                    // 如果是今天，添加当前日期标记
                    if (today.getFullYear() === currentYear && month === today.getMonth() && day === today.getDate()) {
                        cell.classList.add('current');
                    }
                    
                    miniMonthGrid.appendChild(cell);
                }
                
                monthCell.appendChild(miniMonthGrid);
                yearGrid.appendChild(monthCell);
            }
        }
        
        // 显示年视图中某天的详细信息
        function showYearViewDetails(dateStr, records) {
            // 创建详细信息弹窗
            const existingTooltip = document.getElementById('active-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }
            
            const [year, month, day] = dateStr.split('-').map(Number);
            const formattedDate = `${year}年${month}月${day}日`;
            
            alert(`${formattedDate} 的记录 (${records.length}次)\n\n` + 
                  records.map(record => {
                      const date = new Date(record.date);
                      const time = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                      return `• ${time} - ${record.duration}分钟 ${record.notes ? `(${record.notes})` : ''}`;
                  }).join('\n')
            );
        }
        
        // 显示日期详细记录的工具提示
        function showTooltip(event) {
            // 阻止事件冒泡
            event.stopPropagation();
            
            const cell = event.currentTarget;
            const records = JSON.parse(cell.getAttribute('data-records'));
            
            if (!records || records.length === 0) return;
            
            // 移除任何现有的工具提示
            hideTooltip();
            
            // 创建工具提示
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.id = 'active-tooltip';
            
            const dateObj = new Date(records[0].date);
            const formattedDate = `${dateObj.getFullYear()}年${(dateObj.getMonth() + 1)}月${dateObj.getDate()}日`;
            
            let tooltipContent = `<div class="tooltip-title">${formattedDate} (${records.length}次)</div>`;
            
            records.forEach((record, index) => {
                const recordDate = new Date(record.date);
                const time = `${recordDate.getHours().toString().padStart(2, '0')}:${recordDate.getMinutes().toString().padStart(2, '0')}`;
                
                tooltipContent += `<div class="tooltip-record">
                    <span class="tooltip-time">${time}</span>
                    <span class="tooltip-duration">${record.duration}分钟</span>
                    ${record.notes ? `<span class="tooltip-note">${record.notes}</span>` : ''}
                </div>`;
            });
            
            tooltip.innerHTML = tooltipContent;
            
            // 将工具提示添加到日历单元格元素
            cell.appendChild(tooltip);
            
            // 添加可见类以触发动画
            setTimeout(() => {
                tooltip.classList.add('visible');
            }, 10);
            
            // 监听文档点击事件，以便在点击其他地方时关闭提示
            document.addEventListener('click', documentClickHandler);
        }
        
        // 文档点击事件处理程序
        function documentClickHandler(event) {
            // 如果点击不是在有活动工具提示的单元格内，则隐藏工具提示
            const activeTooltip = document.getElementById('active-tooltip');
            if (activeTooltip && !activeTooltip.contains(event.target)) {
                hideTooltip();
                document.removeEventListener('click', documentClickHandler);
            }
        }
        
        // 隐藏工具提示
        function hideTooltip() {
            const tooltip = document.getElementById('active-tooltip');
            if (tooltip) {
                tooltip.classList.remove('visible');
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }, 200);
            }
        }
        
        // 导出数据
        exportBtn.addEventListener('click', () => {
            const records = JSON.parse(localStorage.getItem('records'));
            
            const dataStr = JSON.stringify(records);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `手艺活记录_${new Date().toISOString().slice(0, 10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        });
        
        // 导入数据
        importBtn.addEventListener('click', () => {
            importFile.click();
        });
        
        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (Array.isArray(data)) {
                        if (confirm('导入将覆盖当前数据，确定继续吗？')) {
                            localStorage.setItem('records', JSON.stringify(data));
                            alert('数据导入成功！');
                            updateStats();
                        }
                    } else {
                        alert('无效的数据格式！');
                    }
                } catch (error) {
                    alert('无法解析文件：' + error.message);
                }
            };
            reader.readAsText(file);
        });
        
        // 初始化页面
        updateStats();
        initHistoryFilters();
    </script>
</body>
</html>